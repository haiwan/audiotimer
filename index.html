<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurable Interval Timer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Using HTML Audio Tag for MP3 playback -->
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app-card" class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
        <!-- Adjusted from text-3xl to text-2xl for better fit -->
        <h1 class="text-2xl font-extrabold text-gray-800 mb-6 text-center">Audio Interval Timer</h1>
        <p class="text-gray-500 mb-8 text-center">Set the interval and the total duration for the timer.</p>

        <!-- Total Duration Input -->
        <div class="mb-6">
            <label for="durationMinutes" class="block text-sm font-medium text-gray-700 mb-1">Total Duration (Minutes, Min 1)</label>
            <!-- Default value is 20 -->
            <input type="number" id="durationMinutes" value="20" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-base">
        </div>

        <!-- Interval Inputs -->
        <div class="flex space-x-4 mb-6">
            <div class="flex-1">
                <label for="intervalMinutes" class="block text-sm font-medium text-gray-700 mb-1">Interval Minutes (0-59)</label>
                <!-- Default value is 2 -->
                <input type="number" id="intervalMinutes" value="2" min="0" max="59" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150 text-base">
            </div>
            <div class="flex-1">
                <label for="intervalSeconds" class="block text-sm font-medium text-gray-700 mb-1">Interval Seconds (0-59)</label>
                <!-- Default value is 0 -->
                <input type="number" id="intervalSeconds" value="0" min="0" max="59" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150 text-base">
            </div>
        </div>

        <!-- Control Button -->
        <button id="toggleButton" onclick="toggleTimer()" class="w-full py-4 text-lg font-semibold text-white bg-sky-600 hover:bg-sky-700 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-sky-500 focus:ring-opacity-50">
            Start Timer
        </button>

        <!-- Status and Feedback -->
        <div class="mt-8 p-4 bg-sky-50 rounded-lg border border-sky-200">
            <p id="statusMessage" class="text-center font-medium text-sky-800">Ready to start.</p>
            <!-- Displays time elapsed since start -->
            <p id="elapsedTimeDisplay" class="text-center text-sm font-extrabold text-indigo-700 mt-3">Time Elapsed: --</p>
        </div>

        <!-- Offline Status Indicator -->
        <div id="offlineIndicator" class="mt-6 p-3 text-center text-xs rounded-lg bg-yellow-900 text-yellow-300 hidden">
            <svg class="w-4 h-4 inline-block mr-1 align-text-bottom" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.398 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            App is running offline.
        </div>
    </div>
    
    <!-- Hidden Audio Element for MP3 Playback -->
    <!-- The src attribute points to the uploaded buzzer.mp3 file URL -->
    <audio id="buzzerAudio" src="./buzzer.mp3" preload="auto"></audio>

    <script>
        // --- Service Worker Registration for Offline Capability ---
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(registration => {
                            console.log('Service Worker registered:', registration);
                            // Check network status to update the indicator
                            if (!navigator.onLine) {
                                document.getElementById('offlineIndicator').classList.remove('hidden');
                            }
                        })
                        .catch(error => console.error('Service Worker registration failed:', error));
                });
            }
        }
        
        // Global variables for timer state and IDs
        let intervalId = null;
        let durationTimeoutId = null; 
        let isRunning = false;
        let startTime = null; // Tracks the time the timer started
        let elapsedTimeIntervalId = null; // ID for the elapsed time display update interval

        // Element references
        const intervalMinutesInput = document.getElementById('intervalMinutes');
        const intervalSecondsInput = document.getElementById('intervalSeconds');
        const durationMinutesInput = document.getElementById('durationMinutes');
        const toggleButton = document.getElementById('toggleButton');
        const statusMessage = document.getElementById('statusMessage');
        const elapsedTimeDisplay = document.getElementById('elapsedTimeDisplay'); 
        const buzzerAudio = document.getElementById('buzzerAudio'); // Reference to the new audio element

        
        /**
         * Plays the loaded MP3 file using the HTML Audio Element.
         */
        function playTone() {
            try {
                // Rewind the audio to the beginning for instant playback
                buzzerAudio.play();
                console.log(`Buzzer MP3 played via HTML Audio.`);
            } catch (error) {
                console.error('Error playing audio:', error);
            }
        }


        /**
         * Updates the display to show the total time elapsed since the timer started.
         */
        function updateElapsedTime() {
            if (startTime === null) return;

            const elapsedMs = Date.now() - startTime;
            const totalSeconds = Math.round(elapsedMs / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;

            const minutesStr = minutes.toString().padStart(2, '0');
            const secondsStr = seconds.toString().padStart(2, '0');

            elapsedTimeDisplay.textContent = `Time Elapsed: ${minutesStr}:${secondsStr}`;
        }

        /**
         * Validates the inputs and starts the interval timer.
         */
        function startTimer() {
            // No need to check for audioBuffer as the HTML audio tag handles loading.

            // 1. Get and validate time inputs
            const intervalMinutes = parseInt(intervalMinutesInput.value) || 0;
            const intervalSeconds = parseInt(intervalSecondsInput.value) || 0;
            const totalIntervalSeconds = (intervalMinutes * 60) + intervalSeconds;
            const intervalMilliseconds = totalIntervalSeconds * 1000;

            const durationMinutes = parseInt(durationMinutesInput.value) || 0;
            const totalDurationMilliseconds = durationMinutes * 60 * 1000;

            if (totalIntervalSeconds <= 0) {
                statusMessage.textContent = 'Please enter a total interval time greater than 0 seconds.';
                statusMessage.classList.remove('text-sky-800', 'text-green-700');
                statusMessage.classList.add('text-red-600');
                return;
            }

            if (durationMinutes <= 0) {
                statusMessage.textContent = 'Please set a total duration greater than 0 minutes.';
                statusMessage.classList.remove('text-sky-800', 'text-green-700');
                statusMessage.classList.add('text-red-600');
                return;
            }

            // 2. Set up interval state and UI
            isRunning = true;
            toggleButton.textContent = 'Stop Timer';
            toggleButton.classList.remove('bg-sky-600', 'hover:bg-sky-700', 'focus:ring-sky-500');
            toggleButton.classList.add('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-400');
            
            statusMessage.textContent = `Timer started. Interval: ${totalIntervalSeconds}s. Duration: ${durationMinutes}m.`;
            statusMessage.classList.remove('text-red-600', 'text-sky-800', 'text-indigo-700');
            statusMessage.classList.add('text-green-700');

            // 3. Start elapsed time tracking
            startTime = Date.now();
            updateElapsedTime(); // Update immediately
            elapsedTimeIntervalId = setInterval(updateElapsedTime, 1000); // Update every second

            // 4. Set the repeating interval
            intervalId = setInterval(() => {
                const elapsedMs = Date.now() - startTime;
                
                // Determine the next sound time based on full intervals passed since start.
                // We use Math.round for slight timing drift correction.
                const intervalsPassed = Math.round(elapsedMs / intervalMilliseconds);
                const nextSoundTime = intervalsPassed * intervalMilliseconds;

                // If the next sound time is within 500ms of the total duration, skip the sound.
                // This prevents the sound from playing exactly when the timer is due to stop.
                const timingToleranceMs = 500;
                if (Math.abs(nextSoundTime - totalDurationMilliseconds) < timingToleranceMs) {
                    console.log("Skipping final sound as it aligns with the total duration boundary.");
                    // We let durationTimeoutId handle the official stop and cleanup.
                    return;
                }

                playTone();
            }, intervalMilliseconds);

            // 5. Set the duration timeout to stop the timer automatically
            durationTimeoutId = setTimeout(() => {
                stopTimer(true); 
            }, totalDurationMilliseconds);

            // Disable inputs while running
            intervalMinutesInput.disabled = true;
            intervalSecondsInput.disabled = true;
            durationMinutesInput.disabled = true;
        }

        /**
         * Clears the interval timer and duration timeout.
         * @param {boolean} isAutoStop - True if the timer was stopped automatically by the duration.
         */
        function stopTimer(isAutoStop = false) {
            // Clear all intervals and timeouts
            if (intervalId !== null) {
                clearInterval(intervalId);
                intervalId = null;
            }
            if (durationTimeoutId !== null) {
                clearTimeout(durationTimeoutId);
                durationTimeoutId = null;
            }
            if (elapsedTimeIntervalId !== null) {
                clearInterval(elapsedTimeIntervalId);
                elapsedTimeIntervalId = null;
            }

            // Reset state
            isRunning = false;
            startTime = null; // Reset start time

            // Update button
            toggleButton.textContent = 'Start Timer';
            toggleButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-400');
            toggleButton.classList.add('bg-sky-600', 'hover:bg-sky-700', 'focus:ring-sky-500');

            // Update status message based on stop reason
            if (isAutoStop) {
                statusMessage.textContent = 'Timer finished. The set duration has elapsed.';
                statusMessage.classList.remove('text-red-600', 'text-green-700', 'text-sky-800');
                statusMessage.classList.add('text-indigo-700'); // Use indigo for completion
            } else {
                statusMessage.textContent = 'Timer stopped manually.';
                statusMessage.classList.remove('text-red-600', 'text-green-700', 'text-indigo-700');
                statusMessage.classList.add('text-sky-800'); // Use sky blue for manual stop
            }
            
            // Reset displays and enable inputs
            elapsedTimeDisplay.textContent = 'Time Elapsed: --';
            intervalMinutesInput.disabled = false;
            intervalSecondsInput.disabled = false;
            durationMinutesInput.disabled = false;
        }

        /**
         * Toggles between starting and stopping the timer.
         */
        function toggleTimer() {
            if (isRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }
        
        // --- Initialization ---
        
        // No explicit audio loading necessary since the HTML audio tag handles it.

        // Clean up when the user navigates away 
        window.addEventListener('beforeunload', stopTimer);
        
        registerServiceWorker();
    </script>
</body>
</html>
